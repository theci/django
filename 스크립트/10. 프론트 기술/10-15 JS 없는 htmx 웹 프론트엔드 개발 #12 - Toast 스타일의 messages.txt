이번에는 htmx를 통한 응답에서 장고 메시지를 토스트 스타일로 보여주도록 개선해
보겠습니다. 각 템플릿에서 bootstrap-messages 템플릿 태그를 제거하고, 장고
메시지를 소비하여 bootstrap-toast-messages로 보여지는
__messages-as-toast.html 템플릿을 인클루드합니다.
그리고 매 htmx에서도 토스트 메시지 노출이 되도록 DOM-content-loaded
이벤트를 제거해줍니다.
그러면 HTMX를 통한 저장 이후에 토스트 스타일로 장고 메시지가 잘 보여지는데요.
버그가 하나 있습니다.
BootState 5에서는 하나의 토스트 컨테이너 안에 여러 토스트 요소를 누적하는
방식으로 여러 토스트 메시지를 보여주는데요.
현재 구현에서는 각 토스트 메시지마다 토스트 컨테이너가 생성되고요.
그로 인해 토스트 메시지가 여럿 있어도 같은 위치에 겹쳐 보여지기에 메시지가 한 개만
보여지는 버그가 있습니다.
이는 다음 슬라이드에서 해결해 볼게요.
현재 태그는 저장하면 이렇게 정적인 스타일로 성공 메시지가 보여지고 있습니다.
이를 toast 메시지로 구현해 볼게요.
블로그 앱의 템플릿에서 bootstrap-messages 템플릿 태그를 제거하고,
장고 메시지를 toast 메시지가 보여주는 코드가
구현된__messages-as-toast.html 템플릿을 인클루드합니다.
그런데 태그를 수정하고 저장하면 toast 메시지가 보여지지 않는데요.
messages-as-toast.html 템플릿 내에서
DOM-content-loaded 이벤트 발생 시에 toast 메시지가 발생하도록 되어
있어서 그렇습니다.
DOM-content 로디드 이벤트는 웹페이지 로딩 후에 최초 1회만 발생하죠.
그 이후에 htmx 응답에서 이 코드가 수행되니 동콘텐트 로디드 이벤트가 발생할 일이
없죠. 그러니 토스트 메시지가 노출이 안 되는 것입니다.
동콘텐트 로디드 이벤트 핸들러 부분을 제거하고 응답 즉시 토스트 메시지를 노출하도록
변경합니다. 그럼 수정하면 이렇게 토스트 메세지가 잘 보여집니다.
수정을 계속 반복하면 토스트 메시지는 한 개인데 메세지 아래의 그림자 음영이 점점 짙어지는
것이 보이시나요?
한 위치에 토스트 메시지가 계속 쌓이고 있는 겁니다.
브라우저 개발자 도구로 보시면 이렇게 토스트 컨테이너가 노출된 메시지 개수만큼 쌓여 있죠?
이 토스트 컨테이너는 한 개만 있고 그 안에 토스트 메시지가 여럿 배치되도록 변경되어야
합니다. 앞선 실습에 버그를 해결하여 여러 토스트 메시지가 한 번에 보여질 수 있도록
개선해 보겠습니다.
해결 방법은 토스트 컨테이너를 단 하나만 두고요.
각 장고 메시지가 발생하면 이 토스트 컨테이너에 토스트 요소를 동적으로 추가하는
방법입니다. 코어에 toastmessages.javascript 정적 파일을 하나
생성하고요. 이 파일을 최상위 부모 템플릿에서 로딩해 줍니다.
이 파일이 로딩되면서 바디 요소 끝에 toast 컨테이너를 하나 추가하고요.
바디 요소에서 toastmessages 커스텀 이벤트를 받으면 이벤트 객체에서 메시지 레벨
태그와 메시지 내용을 추출하고요.
새로운 토스트 요소를 생성하여 토스트 컨테이너 요소 처음에 추가하고 토스트 메시지로
보여줍니다. 나중에 보여지는 토스트 메시지가 가장 상단에 보여지기 위해 토스트 컨테이너
요소 처음에 배치했습니다.
그러면 이렇게 장고 메시지 개수만큼 누적되어 토스트 메시지가 보여지게 됩니다.
toastmessages.js 경로에 자바스크립트 파일을 생성합니다
각 장고 메시지의 레벨 태그에 맞춰 색상 클래스를 결정해주는 두 개 함수가 있고요 초기
로딩 시에 바디 요소에 toast 컨테이너를 하나 추가해주고 바디 요소에 대해서 toast
메세지 커스텀 이벤트에 대한 리스너를 추가합니다
새로운 메시지가 있으면 토스트 메시지 이벤트를 발생하도록 할 것이고요.
이벤트 발생 시에 메시지의 레벨 태그와 메시지 내용을 인자로 전달받도록 할 것입니다.
레벨 태그에 맞게 색상 클래스를 결정하고요.
토스트 메시지에 HTML 문자열을 생성하고, 토스트 컨테이너 처음에 추가하고, 토스트
메시지로 노출시킵니다.
토스트 메시지 이벤트를 발생시키는 코드가 아직 없죠?
core-template-core-messages-as-event.html 템플릿 파일을
생성하고요. 각 템플릿에도 적용해 줍니다.
underbar-messages-as-event.html 템플릿에서는 각 장고 메시지마다
toast 메시지 이벤트를 레벨 태그와 메시지 내용과 함께 발생시키도록 합니다.
자바스크립트 파일들은 UI가 보여지는 것과 직접적으로 덱에 관련이 없어요.
그래서 덱의 웹페이지 끝으로 몰아서 화면이 조금이라도 빨리 뜨도록 하거든요.
블로그에 base.html 템플릿에서 자바스크립트 파일들을 웹페이지 끝으로 몰겠습니다.
코어에 toastmessages.js 자바스크립트 파일도 로딩토록 합니다.
웹페이지 새로고침하시고 수정을 이어서 여럿 해보시면 이렇게 toast 메시지들이 누적되어
여러 메세지가 보여짐을 확인하실 수 있습니다.




문제 해결 과정: Django와 HTMX에서 Toast 스타일 메시지 처리
1. 초기 문제

Django 메시지를 Toast 스타일로 보여주기 위해, bootstrap-messages 템플릿 태그를 제거하고 messages-as-toast.html 템플릿을 사용하려 했지만, HTMX 응답 후 Toast 메시지가 제대로 표시되지 않는 문제가 발생했습니다. 이는 DOM-content-loaded 이벤트가 이미 실행되어 이후에 발생하는 HTMX 응답에서는 이벤트가 발생하지 않기 때문입니다.
2. 해결 방법

DOM-content-loaded 이벤트 제거: 이벤트를 제거하고, HTMX 응답 즉시 Toast 메시지를 노출하도록 수정했습니다. 이를 통해, 페이지 로딩 이후 HTMX로 받은 응답에서도 Toast 메시지가 올바르게 표시됩니다.
3. 버그 발생

여러 Toast 메시지 겹침 문제: 메시지를 여러 번 수정을 반복하면서 여러 Toast 메시지가 겹쳐서 표시되는 버그가 발생했습니다. 이는 각각의 메시지마다 별도의 Toast 컨테이너가 생성되었기 때문입니다. 이로 인해, 여러 메시지가 같은 위치에 겹쳐서 나타나고, 최종적으로 한 개의 메시지만 표시됩니다.
4. 버그 해결

단일 Toast 컨테이너로 변경: 여러 메시지가 겹치는 문제를 해결하기 위해, 하나의 Toast 컨테이너를 두고, 각 Django 메시지가 발생할 때마다 동적으로 Toast 요소를 추가하도록 수정했습니다. 이렇게 하면, 여러 메시지가 누적되더라도 하나의 위치에서 올바르게 표시됩니다.

toastmessages.js 파일 추가: 새로운 자바스크립트 파일을 생성하여, 페이지 로딩 시에 Toast 컨테이너를 추가하고, 이후 toastmessages 커스텀 이벤트를 받아서 해당 이벤트에 맞는 메시지를 표시하도록 했습니다.

Toast 메시지 표시: 각 메시지의 레벨에 맞는 색상 클래스를 설정하고, 메시지 내용을 HTML로 생성하여 Toast 컨테이너에 동적으로 추가합니다. 이렇게 하면 여러 메시지가 순차적으로 올바른 위치에 표시됩니다.

5. 실행 과정

템플릿 변경: __messages-as-toast.html에서 DOM-content-loaded 이벤트를 제거하고, 메시지를 동적으로 처리하도록 수정했습니다.
JavaScript 코드: toastmessages.js 파일을 작성하여 Toast 컨테이너 생성 및 메시지 이벤트 리스닝을 구현했습니다.
HTML 변경: core-template-core-messages-as-event.html 템플릿을 추가하여, 각 Django 메시지마다 Toast 메시지 이벤트를 발생시키도록 했습니다.

6. 최종 구현

Toast 메시지가 누적되어 여러 개의 메시지가 표시됩니다. 이제 여러 메시지가 동시에 한 컨테이너 안에서 올바르게 표시되며, 새로운 메시지가 최상단에 위치하게 됩니다.
자바스크립트 최적화: 자바스크립트 파일들은 페이지 로딩 후 빠르게 처리되도록 페이지 끝부분에 위치시켜, 페이지 로딩 속도를 개선했습니다.
결론
HTMX와 Django 메시지를 이용하여 Toast 스타일의 알림을 구현할 수 있었습니다. 단일 Toast 컨테이너 방식으로 여러 메시지를 겹치지 않게 표시하고, **toastmessages.js**를 활용하여 이벤트 기반으로 동적으로 메시지를 처리하도록 개선했습니다.
최종적으로 여러 Toast 메시지가 순차적으로 누적되어 화면에 표시되며, 이를 통해 사용자에게 알림을 효과적으로 전달할 수 있게 되었습니다.

