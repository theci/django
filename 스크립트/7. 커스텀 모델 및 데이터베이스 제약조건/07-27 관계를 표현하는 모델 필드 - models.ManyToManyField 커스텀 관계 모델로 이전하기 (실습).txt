커스텀 관계 모델로 이전하는 마이그레이션 과정을 살펴봅시다.
첫 번째로 먼저 새로운 관계 모델 클래스를 정의합니다.
모델 클래스만 정의할 뿐 ManyToManyField 설정은 그대로 두고요.
makeMigrations 명령으로 마이그레이션 파일을 생성합니다.
이 마이그레이션을 수행하면 새 관계 모델에 대한 데이터베이스 테이블이 생성이 될 것입니다.
두번째로, 방금 생성한 마이그레이션 파일을 수정하여 디폴트 ManyToMany 관계
모델로부터 새로운 관계 모델로 데이터를 복제하는 run-python-operation을
추가합니다. PostModel 클래스의 태그 언더바의 .through 속성은 태그 언더바
셋 M2M 관계의 관계 모델 클래스입니다.
이 디폴트 관계 모델 클래스를 통해 기존 관계 데이터를 조회하여 웰의 키 값을 새로운 관계
모델 인스턴스 생성에 사용하고 bulk_create를 통해 한 번에 데이터베이스에 저장합니다.
그럼 관계 데이터가 다 복제된 것입니다..
세 번째로 디폴트 관계 테이블 삭제를 위해 Post 모델의 태그 언더바 셋 필드를 주석
처리하시고 저장하신 후에 마이그레이션 파일을 생성해 주세요.
이 마이그레이션을 수행하면 디폴트 관계 테이블이 데이터베이스에서 삭제될 것입니다.
이제 주석 처리한 태그 언더바 셋 필드를 살리시고 새로운 관계 모델과 함께 through
설정과 through 필드 설정을 지정하시고 마이그레이션 파일을 생성합니다.
그럼 커스텀 관계 모델 이전에 대한 사전 작업이 끝났고요.
migrate 명령을 수행하면 앞서 생성한 4개의 마이그레이션들이 순차적으로 수행되며 이전
작업이 성공할 것입니다.
이어서 실습을 해 볼게요.
디폴트 관계 테이블인 BlogPostTagSet의 데이터는 이와 같습니다.
이 관계 데이터를 새로운 관계 테이블로 옮기는 마이그레이션을 작성해 보겠습니다.
BlogModel.py 파일에 PostTagRelationModel 클래스를 정의합니다.
아직 PostModel의 태그셋 필드 설정은 그대로 두고요, make_migrations
명령으로 PostTagRelation 모델에 대한 테이블을 생성하는 마이그레이션 파일을
생성합니다.
마이그레이션 오류 상황을 겪어보기 위해 PostModel의 태그셋 모델 필드에
through 설정에 PostTagRelation 모델을 적용해 봅시다.
makemigrations 명령과 Migrate 명령을 순차적으로 실행해 보시면, 블로그
앱에 0020 마이그레이션은 수행되지만, 0021 마이그레이션 수행에서 오류가 발생함을
확인하실 수 있습니다.
0021 마이그레이션 파일은 삭제해 주시고요.
블로그 앱의 0020 마이그레이션 파일에 PostTagRelation 모델을 통해 관계
데이터를 추가하는 LearnPython 오퍼레이션을 추가하겠습니다
첫 번째 오퍼레이션은 PostTagRelation 모델에 대한 데이터베이스 테이블을
생성하는 오퍼레이션이고요 두 번째 오퍼레이션은 PostTagRelation 모델에서
Post 외래키와 태그 외래키에 대한 유니크 제약 조건을 추가하는 오퍼레이션입니다
끝에 새로운 LearnPython 오퍼레이션을 추가합니다
마이그레이션 파일 상단에 CopyRelations 함수를 구현하겠습니다.
PostModel과 PostTagRelation 모델도 임포트하시고요.
Post.tagSet.thru 속성은 PostModel 태그셋필드에 대한 관계 모델
클래스입니다.
Default 관계 모델 클래스를 조회해서 Post 모델에 대한 외래 키 값과 태그 모델에
대한 외래 키 값을 조회합니다.
각 메리킷 값으로 PostTagRelation 모델 인스턴스를 생성하고 리스트에 추가해서
bulk create를 통해 한 번에 데이터베이스에 저장하겠습니다.
showmigrations 블로그 명령으로 블로그 앱에 마이그레이션 적용 현황을 보면
0020 마이그레이션까지 적용되어 있습니다.
우리는 0020 마이그레이션을 수행해야 하는데, 런파이선 오퍼레이션이 없었던 0020
마이걸션이 적용되어 있으니, 0020 파일에 런파이썬 오퍼레이션 코드를 잠시 주석
처리하고, 0020 마이걸션을 롤백한 후에 0020 마이걸션을 적용하겠습니다.
런파이선 오퍼레이션의 리버스 동작에서는 NO-OP 즉, 노 오퍼레이션 함수가 적용되어
있어서, 리버스 동작 시에 아무런 작업을 하지 않으니, 주석 처리를 하지 않으셔도 상관은
없습니다. 런파이썬 오프레이션 코드의 주석을 풀고 저장하신 후에 0020 마이그레이션을
적용합니다. 그러면 Post-tag Relation 모델에 대한 데이터베이스 테이블이
생성됨과 동시에 기존 관계 테이블의 관계 데이터를 복사하게 됩니다.
기존 관계 테이블을 삭제하는 마이그레이션을 생성하기 위해서 Post 모델의 태그셋 필드를
주석 처리하고 makemigrations 명령을 수행해 주세요.
태그셋 필드에 적용된 주석을 해제하시고 새로운 관계 모델도 맵핑해 줍니다.
새로운 마이그레이션 파일을 생성하고 마이그레이트 명령으로 적용하시면 커스텀 관계 모델로의
이전 마이그레이션 과정이 끝났습니다.
데이터베이스 패널에서 새로고침해 주시고요.
생성된 block_post_tag_relation 테이블 내역을 보시면
관계 데이터가 다 복사되었음을 확인하실 수 있습니다.
장고 셀을 구동하시고, post-model, 태그셋 필드의 관계 모델도
post-tag-relation으로 잘 적용되어 있고요.
태그 목록도 조회해 보시면 잘 동작합니다.