Accounts의 Utils.py 경로에 환영 이메일을 발송하는
SendWelcomeEmail 함수를 구현하겠습니다.
인자로 이메일을 수신할 UserModel 인스턴스를 하나 받겠습니다.
이메일 제목과 이메일 내용 생성이 필요한데요.
Django 템플릿 엔진을 활용해서 제목과 내용 문자열을 생성하겠습니다.
이메일 제목 템플릿은 accounts의 welcome 이메일 밑에 subject.txt 경로의 파일을 사용하겠고요.
이메일 내용 템플릿은 accounts의 welcome 이메일 밑에 content.txt 경로의 파일을 사용하겠습니다.
제목 템플릿과 내용 템플릿 내용은 간결하게 작성했고요.
뷰 함수에서 render 함수는 http response 응답 객체를 반환하는데요.
우리는 응답 객체가 아닌 템플릿을 통해 조합한 문자열이 필요하죠.
이때에는 renderToString 함수를 활용합니다.
첫 번째 인자로 사용할 템플릿 경로를 지정하고요.
두 번째 인자로 템플릿 렌더링 시에 참조할 컨텍스트 데이터 사전을 지정합니다.
제목 문자열과 내용 문자열이 준비되면 샌드 메일 함수를 통해 메일을 발송하고요.
첫 번째 인자는 제목 문자열, 두 번째 인자는 내용 문자열, 세 번째 인자는 송신자 이메일 주소이고요.
settings의 디폴트 송신자 이메일 주소 설정을 사용하겠습니다.
네 번째 인자는 수신자 이메일 주소 리스트입니다.
유저의 메일 주소를 리스트로 전달하겠습니다.
그리고 유저에게 이메일 주소가 등록이 되어 있을 때에만 이메일 발송을 시도합니다.
이메일에서 제목 문자열은 제어 문자 없이 한 줄 문자열이어야 합니다.
한 줄 문자열이 아니면 SMTP 프로토콜에 맞지 않아 메일 발송에 실패합니다.
템플릿을 통해 문자열을 조합하다 보면 한 줄로 조합하려고 해도 끝에 혹은 중간에 엉뚱하게 계획 문자가 붙어 두 줄 이상이 되는 경우가 종종 발생합니다.
그래서 제목 문자열을 제어 문자를 구분자로 리스트화 시킨 후에 공백 문자열로 다시 합쳐서 제어 문자를 제거하고 한 줄 문자열로 변경하겠습니다.
손쉬운 환영 이메일 발송 확인을 위해 환영 이메일을 발송하는 커스텀 장고 관리 관리 명령 TestSendWelcome 이메일을 구현해 주겠습니다.
BaseCommand 클래스를 상속받은 Command 클래스를 정의하고요.
Help 클래스 변수로 명령 설명을 작성하고요.
add_arguments 메서드를 통해 필요한 명령 인자를 지정하고 핸들 메서드를 통해 명령의 동작을 구현합니다.
핸들 함수의 키워드 인자로 명령의 인자를 전달받습니다.
지정 이메일의 유저를 찾고 없다면 에러 스타일의 오류 메시지를 표준 에러로 출력하고요.
유저를 찾았다면 이메일을 발송하고 표준 출력으로 성공 메시지를 출력합니다.
Python manage.py help 명령 실행해 보시면 Accounts 앱 내에 TestSendWelcome 이메일 명령이 등록되어 있음을 확인하실 수 있고요.
시스템에 등록된 이메일 주소로 명령을 실행해 보시면 이렇게 성공 메시지가 출력되고요.
시스템에 등록되지 않은 메일 주소로 명령을 실행해 보시면 이렇게 실패 메시지가 출력됩니다.
방금 명령을 통해 수신한 환영 이메일입니다.
이제 유저가 회원가입을 하면 유저 레코드를 생성하는 즉시 환영 이메일을 발송해 보겠습니다.
사인업 뷰, 회원가입 뷰에서 부모의 폰벨리드 메서드를 호출하면 유저 레코드가 생성된 다음이죠.
SendWelcomeEmail 함수를 즉시 호출해 주겠습니다.
CreatorView, Class 기반 뷰에서는 저장된 모델 인스턴스는 Object 멤버 변수에 저장합니다.
저장된 모델 인스턴스가 환영 이메일을 받을 유저 인스턴스가 됩니다.
SendMail 함수에서는 Fail, Silently 인자가 지원되고요.
이메일 발송 중에 오류가 발생하면 예외 발생 없이 조용히 무시할 것인지를 지정하는 플래그 인자이고, 디폴트도 거짓입니다.
디폴트로 메일 발송에 실패하면 예외가 발생하는 것이고요.
회원 가입 중인 유저에게 500 인터널 서버 에러 응답을 주게 되겠죠.
sendWelcomeEmail 함수에 failSilently 인자를 추가하여 메일 발송 시에 이 설정을 지정할 수 있도록 합니다.
회원가입 뷰에서는 메일 발송 시에 오류가 발생하더라도 예외가 발생되지 않도록 페이 사일런틀리 인자를 참으로 지정해주겠습니다.
이제 새로운 아이디 이메일로 회원가입을 해보시면 회원가입 과정이 정상적으로 처리되고요.
지정 이메일 주소로 환영 이메일도 이렇게 받게 됩니다.